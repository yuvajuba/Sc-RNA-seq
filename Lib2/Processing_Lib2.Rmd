---
title: "ScRNAseq analysis"
subtitle: "Library 2 pre-processing"
author: "Juba"
date: "Compiled on: `r Sys.Date()`"
output: 
  html_document:
    number_sections: no
    theme: flatly
    highlight: tango
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: false
      smooth_scroll: true
    df_print: paged 
    css: style.css
---

```{r Setting, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
rm(list = ls())
graphics.off()
cat("\014")

## Set chunk options
knitr::opts_chunk$set(message = FALSE, warning = FALSE, 
                      echo = FALSE, error = FALSE, 
                      fig.height = 6, fig.width = 7)

## Set a timer
starting_time <- Sys.time()


# SETUP ENVIRONNEMENT :
# =================== :
source("d:/Projects/Thesis/00_setup.R")

# Directories :
# =========== :
out_dir <- "d:/Projects/Thesis/Lib2/out_obj/"
fig_dir <- "d:/Projects/Thesis/Lib2/out_fig/"
seu_dir <- "d:/Projects/Thesis/Lib2/SeuratObject/"
```

#   Import the data   {.tabset .tabset-pills}

```{r}
SeuratObj <- readRDS(paste0(seu_dir,"Seurat1.rds"))
SeuratObj
```

```{r}
SeuratObj@meta.data <- SeuratObj@meta.data %>% 
  mutate(Condition = case_when(
    hash.ID == "M143" ~ "Diagnosis",
    hash.ID == "M148" ~ "Relapse"
  ))

SeuratObj@meta.data <- SeuratObj@meta.data %>% 
  mutate(
    Clonotype = case_when(startsWith(clone_id,"clono") ~ sub("onotype","",clone_id),
                          TRUE ~ clone_id),
    Clust_res0.1 = as.factor(paste0(SCT_snn_res.0.1, substr(SeuratObj$Condition,1,1))),
    Clust_res0.3 = as.factor(paste0(SCT_snn_res.0.3, substr(SeuratObj$Condition,1,1))),
    Clust_res0.5 = as.factor(paste0(SCT_snn_res.0.5, substr(SeuratObj$Condition,1,1))),
    Clust_res0.7 = as.factor(paste0(SCT_snn_res.0.7, substr(SeuratObj$Condition,1,1))),
    Clust_res0.9 = as.factor(paste0(SCT_snn_res.0.9, substr(SeuratObj$Condition,1,1))),
    Clust_res1.1 = as.factor(paste0(SCT_snn_res.1.1, substr(SeuratObj$Condition,1,1))),
    Clust_res1.3 = as.factor(paste0(SCT_snn_res.1.3, substr(SeuratObj$Condition,1,1))),
    Clust_res1.5 = as.factor(paste0(SCT_snn_res.1.5, substr(SeuratObj$Condition,1,1)))
  )
```


[Here're some representation]{style='color:darkred ; font-weight:600 ; font-size:120%'}

##    General conditions

```{r}
DimPlot(SeuratObj,
        group.by = "Condition",
        pt.size = .9,
        alpha = .7,
        label = F,
        label.box = T,
        repel = T, 
        label.color = "#fff")+
  My_umap_theme()+
  scale_colour_manual(values = MyPalette)
```


##    Clusteres at res0.1

```{r}
DimPlot(SeuratObj,
        group.by = "Clust_res0.1",
        pt.size = .9,
        alpha = .7,
        label = T,
        label.box = T,
        repel = T, 
        label.color = "#fff")+
  My_umap_theme()+
  scale_colour_manual(values = MyPalette)+
  scale_fill_manual(values = MyPalette)
```

##    Clonotypes distributions

```{r}
DimPlot(SeuratObj,
        group.by = "Clonotype",
        pt.size = .9,
        alpha = .7,
        label = F,
        label.box = T,
        repel = T, 
        label.color = "#fff",
        label.size = 4)+
  My_umap_theme()+
  theme(legend.position = "none")+
  scale_colour_manual(values = c(MyPalette, colors(distinct = T)))
```


##    Cell cycle distribution

```{r}
DimPlot(SeuratObj,
        group.by = "Phase",
        pt.size = .9,
        alpha = .7,
        label = T,
        label.box = T,
        repel = T, 
        label.color = "#fff")+
  My_umap_theme()+
  scale_colour_manual(values = MyPalette)+
  scale_fill_manual(values = MyPalette)
```



<br></br><br></br><br></br><br></br>

#   Cells inspection    {.tabset .tabset-pills}

[I'll inspect the expression of some markers to determine the cell types]{style='color:darkred ; font-weight:600 ; font-size:120%'}

This will help us determine any cluster that may not be of interest ! (clusters at res 0.1)

```{r}
DimPlot(SeuratObj, 
        cols = MyPalette, 
        group.by = "SCT_snn_res.0.1",
        pt.size = 1, 
        label = T, label.box = T, repel = T, label.color = "white", label.size = 4)+
  My_umap_theme()
```


##    T lymphocytes

```{r ,fig.width=10, fig.height=8}
try(FeaturePlot(SeuratObj, 
            features = c("CD3D","CD4","CD8A","IL7R"), 
            cols = c("#EEEEEE","#221166"),
            keep.scale = "all"))
```


##    Other cell types

Basically here, we're looking for

-   Monocytes & macrophages (CD14, LYZ)
-   NK cells (NKG7, GNLY)
-   B Lymphocytes (CD19, CD27)

```{r ,fig.width=11, fig.height=8}
try(VlnPlot(SeuratObj, 
            features = c("CD14","LYZ","NKG7","GNLY","CD19","CD27"), 
            ncol = 3, 
            group.by = "SCT_snn_res.0.1",
            cols = MyPalette, 
            same.y.lims = T))
```

As for the feature plots :

```{r ,fig.width=11, fig.height=8}
try(FeaturePlot(SeuratObj, 
            features = c("CD14","LYZ","NKG7","GNLY","CD19","CD27"), 
            cols = c("#EEEEEE","#221166"),
            keep.scale = "all",
            ncol = 3))
```

<br></br><br></br><br></br><br></br>

#   Clonotypes inspection 

[Now we'll inspect the distribution of the clonotypes]{style='color:darkred ; font-size:120%'}

```{r, rows.print=6}
SeuratObj@meta.data %>% 
  dplyr::count(clone_id) %>% 
  dplyr::arrange(desc(n)) %>% 
  head(12)
```

```{r}
DimPlot(SeuratObj,
        group.by = "clone_id",
        cols = c(MyPalette, colors(distinct = T)),
        pt.size = 1,
        alpha = .7) +
  My_umap_theme()+
  theme(legend.position = "none")
```


[Let's group unique and low-count clones together]{style='color:darkred; font-size:120%; margin-top:20px'}

```{r}
SeuratObj@meta.data %>% 
  dplyr::count(Clonotype) %>% 
  dplyr::mutate(cl = case_when(n == 1 ~ "unique",
                               n >= 2 & n < 7 ~ "few",
                               TRUE ~ Clonotype)) -> tmp

unique_cl <- tmp$Clonotype[which(tmp$cl == "unique")]
low_cl <- tmp$Clonotype[which(tmp$cl == "few")]

SeuratObj@meta.data <- SeuratObj@meta.data %>% 
  dplyr::mutate(Clonotype = case_when(is.na(Clonotype) ~ "missing",
                                      Clonotype %in% unique_cl ~ "unique",
                                      Clonotype %in% low_cl ~ "low_count",
                                      TRUE ~ Clonotype))

rm(tmp, unique_cl, low_cl)

SeuratObj@meta.data %>% 
  dplyr::count(Clonotype) %>% 
  dplyr::arrange(desc(n)) %>% 
  head(10)
```

```{r}
DimPlot(SeuratObj,
        group.by = "Clonotype",
        cols = c(MyPalette, colors(distinct = T)),
        pt.size = 1,
        alpha = .7) +
  My_umap_theme()
```


[Now let's see the distribution among the conditions and the clusters]{style='color:darkred ; font-size:120%; margin-top:20px'}

```{r ,fig.height=16, fig.width=12}
SeuratObj@meta.data %>% 
  ggplot(aes(x= umap_1,
             y= umap_2))+
  My_umap_theme()+
  geom_point(aes(colour= Clonotype),
             size = .6,
             alpha = .7)+
  facet_grid(SCT_snn_res.0.1 ~ Condition, 
             margins = T, switch = "y")+
  theme(plot.margin = margin(t=0.05,b=0.05,l=0.05,r=0.05, unit = "in"),
        panel.background = element_rect(colour = "#555"))+
  guides(colour = guide_legend(override.aes = list(size = 3)))+
  scale_colour_manual(values = MyPalette)
```


## Clones among conditions

```{r}
DimPlot(SeuratObj,
        group.by = "Condition",
        cols = c(MyPalette, colors(distinct = T)),
        pt.size = 1,
        alpha = .7,
        label = T,
        label.box = T,
        label.color = "#fff",
        repel = T) +
  My_umap_theme()
```

```{r ,rows.print=5}
SeuratObj@meta.data %>% 
  dplyr::count(Condition, Clonotype) %>% 
  dplyr::arrange(desc(n))
```

```{r}
t <- 200
SeuratObj@meta.data %>% 
  dplyr::count(Condition, Clonotype) %>% 
  ggplot(aes(x= Condition, y= n, fill= Clonotype))+
  geom_bar(position = "stack",
           stat = "identity",
           width = .8)+
  geom_text(aes(label= ifelse(n >= t, n, "")),
            position = position_stack(vjust = 0.5, reverse = F),
            colour = "white",
            size = 4,
            fontface = "bold")+
  scale_fill_manual(values = MyPalette)+
  labs(title = "Clonotypes distribution",
       y = "Count",
       caption = paste0("Label count min threshold : ", t))+
  My_bplot_theme()
```


## Clones among clusters

```{r}
DimPlot(SeuratObj,
        group.by = "Clust_res0.1",
        cols = c(MyPalette, colors(distinct = T)),
        pt.size = 1,
        alpha = .7,
        label = T,
        label.box = T,
        label.color = "#fff",
        repel = T)+
  My_umap_theme()+
  scale_fill_manual(values = MyPalette)
```

```{r ,rows.print=5}
SeuratObj@meta.data %>% 
  dplyr::count(Clust_res0.1, Clonotype) %>% 
  dplyr::arrange(desc(n))
```

```{r}
t <- 150
SeuratObj@meta.data %>% 
  dplyr::count(Clust_res0.1, Clonotype) %>% 
  ggplot(aes(x= Clust_res0.1, y= n, fill= Clonotype))+
  geom_bar(position = "stack",
           stat = "identity",
           width = .8)+
  geom_text(aes(label= ifelse(n >= t, n, "")),
            position = position_stack(vjust = 0.5, reverse = F),
            colour = "white",
            size = 3,
            fontface = "bold")+
  scale_fill_manual(values = MyPalette)+
  labs(title = "Clonotypes distribution",
       y = "Count",
       caption = paste0("Label count min threshold : ", t))+
  My_bplot_theme()

SeuratObj@meta.data %>% 
  dplyr::count(Clust_res0.1, Clonotype) %>% 
  ggplot(aes(x= Clust_res0.1, y= n))+
  geom_bar(aes(fill= Clonotype),
           position = "fill",
           stat = "identity",
           width = .8)+
  scale_fill_manual(values = MyPalette)+
  labs(title = "Clonotypes distribution",
       y = "Proportion")+
  My_bplot_theme()
```



<br></br><br></br><br></br><br></br>

# Filtering cells

[Now let's filter unwanted cells]{style='color:darkred ; font-size:120%'}

```{r ,echo=TRUE}
# define cells to remove :
# ---------------------- :
cells_rm <- WhichCells(
  SeuratObj, 
  expression = umap_1 > 5 | 
    Clonotype %in% c("unique","low_count")
)

# subset seurat object :
# -------------------- :
SeuratObj_filt <- subset(SeuratObj, cells = setdiff(Cells(SeuratObj),cells_rm))

# rejoin conditions and clusters :
# ------------------------------ :
SeuratObj_filt@meta.data <- SeuratObj_filt@meta.data %>% 
  mutate(MyClusters = case_when(
    umap_2 < -1 & Condition == "Relapse" ~ "R",
    umap_2 < -1 & Condition == "Diagnosis" ~ "D_in_R",
    umap_2 > -1 & Condition == "Relapse" ~ "R_in_D",
    umap_2 > -1 & Condition == "Diagnosis" ~ "D"
  ))

# plot :
# ---- :
DimPlot(SeuratObj_filt,
        group.by = "MyClusters",
        cols = c(MyPalette, colors(distinct = T)),
        pt.size = 1,
        alpha = .7,
        label = T,
        label.box = T,
        label.color = "#fff",
        repel = T)+
  My_umap_theme()+
  scale_fill_manual(values = MyPalette)
```

Set a threshold of __30 cells__ minimum to be kept for further analysis (so any cluster below 30 will be filtered again)

```{r ,rows.print=8}
SeuratObj_filt@meta.data %>% 
  dplyr::count(MyClusters,Clonotype) %>% 
  dplyr::arrange(n)
```

Removing Rel_in_Diag & Diag_in_Rel

```{r}
# 1.
cells_rm <- WhichCells(
  SeuratObj_filt, 
  expression = MyClusters %in% c("R_in_D", "D_in_R")
)

# 2.
SeuratObj_filt <- subset(SeuratObj_filt, cells = setdiff(Cells(SeuratObj_filt),cells_rm))

# 3.
DimPlot(SeuratObj_filt,
        group.by = "MyClusters",
        cols = c(MyPalette, colors(distinct = T)),
        pt.size = 1,
        alpha = .7,
        label = T,
        label.box = T,
        label.color = "#fff",
        repel = T)+
  My_umap_theme()+
  scale_fill_manual(values = MyPalette)
```




#   TCR inspections

[Now, let's inspect the VDJ expression :]{style='color:darkred; font-size:110%'}

-   Among our conditions
-   Among the clonotypes

```{r}
DimPlot(SeuratObj_filt,
        group.by = "v_call",
        cols = c(MyPalette, colors(distinct = T)),
        pt.size = 1,
        alpha = .7) +
  My_umap_theme()+
  theme(legend.position = "none")
```

```{r}
SeuratObj_filt@meta.data <- SeuratObj_filt@meta.data %>% 
  mutate(TCR = case_when(is.na(v_call) ~ "Missing",
                         TRUE ~ v_call))

SeuratObj_filt@meta.data %>% 
  dplyr::count(TCR) %>% 
  dplyr::arrange(desc(n))
```


```{r ,fig.width=11, fig.height=13}
SeuratObj_filt@meta.data %>% 
  ggplot(aes(x= umap_1,
             y= umap_2))+
  My_umap_theme()+
  geom_point(aes(colour= TCR),
             size = .6,
             alpha = .7)+
  facet_grid(Clonotype ~ MyClusters, 
             margins = T, switch = "y")+
  theme(plot.margin = margin(t=0.05,b=0.05,l=0.05,r=0.05, unit = "in"),
        panel.background = element_rect(colour = "#ccc"),
        legend.key = element_blank())+
  guides(colour = guide_legend(override.aes = list(size = 3)))+
  scale_colour_manual(values = MyPalette)+
  labs(colour = "TCR")
  
```

```{r}
SeuratObj_filt@meta.data %>% 
  dplyr::count(MyClusters, TCR) %>% 
  ggplot(aes(x= MyClusters, y= n, fill= TCR))+
  geom_bar(position = "stack",
           stat = "identity",
           width = .8)+
  scale_fill_manual(values = MyPalette)+
  labs(title = "TCR distribution",
       y = "Count")+
  My_bplot_theme()+
  geom_text(aes(label = ifelse(n > 200, n, "")),
            position = position_stack(vjust = 0.5, reverse = F),
            colour = "black",
            size = 4,
            fontface = "bold")+
  geom_text_repel(aes(label = ifelse(n < 200, n,"")), 
                  position = position_stack(vjust = 0.5), 
                  color = "black", size = 4, fontface = "bold", 
                  box.padding = 0.5,    # Espace autour du texte
                  point.padding = 0.6,  # Distance par rapport au point
                  segment.size = 0.4,   # Taille de la ligne reliant texte et point
                  min.segment.length = 0)
```

```{r}
SeuratObj_filt@meta.data %>% 
  dplyr::count(Clonotype, TCR) %>% 
  ggplot(aes(x= Clonotype, y= n, fill= TCR))+
  geom_bar(position = "stack",
           stat = "identity",
           width = .8)+
  scale_fill_manual(values = MyPalette)+
  labs(title = "TCR distribution",
       y = "Count")+
  My_bplot_theme()+
  geom_text(aes(label = ifelse(n > 200, n, "")),
            position = position_stack(vjust = 0.5, reverse = F),
            colour = "black",
            size = 4,
            fontface = "bold")+
  geom_text_repel(aes(label = ifelse(n < 200, n,"")), 
                  position = position_stack(vjust = 0.5), 
                  color = "black", size = 4, fontface = "bold", 
                  box.padding = 0.5,    
                  point.padding = 0.6,  
                  segment.size = 0.4,   
                  min.segment.length = 0)
```


<br></br><br></br><br></br><br></br>

#   Cell cycle inspection

[Now, let's inspect the cell cycle of the TCRs :]{style='color:darkred; font-size:110%'}


```{r ,fig.width=11, fig.height=13}
SeuratObj_filt@meta.data %>% 
  ggplot(aes(x= umap_1,
             y= umap_2))+
  My_umap_theme()+
  geom_point(aes(colour= Phase),
             size = .6,
             alpha = .7)+
  facet_grid(TCR ~ Condition, 
             margins = T, switch = "y")+
  theme(plot.margin = margin(t=0.05,b=0.05,l=0.05,r=0.05, unit = "in"),
        panel.background = element_rect(colour = "#555"),
        legend.key = element_blank())+
  guides(colour = guide_legend(override.aes = list(size = 3)))+
  scale_colour_manual(values = MyPalette)+
  labs(colour = "Cell cycle")
  
```


[Now, let's inspect the cell cycle of the clonotypes :]{style='color:darkred; font-size:110%'}

```{r ,fig.width=11, fig.height=15}
SeuratObj_filt@meta.data %>% 
  ggplot(aes(x= umap_1,
             y= umap_2))+
  My_umap_theme()+
  geom_point(aes(colour= Phase),
             size = .7,
             alpha = .7)+
  facet_grid(Clonotype ~ Condition, 
             margins = T, switch = "y")+
  theme(plot.margin = margin(t=0.05,b=0.05,l=0.05,r=0.05, unit = "in"),
        panel.background = element_rect(colour = "#555"),
        legend.key = element_blank())+
  guides(colour = guide_legend(override.aes = list(size = 3)))+
  scale_colour_manual(values = MyPalette)+
  labs(colour = "Cell cycle")
  
```


```{r}
SeuratObj_filt@meta.data <- SeuratObj_filt@meta.data %>% 
  mutate(Cond_Cl_TCR = paste0(MyClusters,"_",Clonotype,"_",TCR),
         Cond_cl = paste0(MyClusters,"_",Clonotype),
         Cond_TCR = paste0(MyClusters,"_",TCR),
         Clone_TCR = paste0(Clonotype,"_",TCR))
```



[Now, let's dive deeper]{style='color:darkred; font-size:130%; font-weight:600; margin-top:40px'}

We'll inspect the cell cycle within the 3 major clonotypes (cl1, cl2, cl3) 
against each TCR


## Clonotype 1

```{r ,fig.width=10, fig.height=9}
tmp <- subset(SeuratObj_filt, subset = Clonotype == "cl1")


tmp@meta.data %>% 
  ggplot(aes(x= umap_1,
             y= umap_2))+
  My_umap_theme()+
  geom_point(aes(colour= Phase),
             size = .7,
             alpha = .7)+
  facet_grid(TCR ~ Condition, 
             margins = T, switch = "y")+
  theme(plot.margin = margin(t=0.05,b=0.05,l=0.05,r=0.05, unit = "in"),
        panel.background = element_rect(colour = "#555"),
        legend.key = element_blank())+
  guides(colour = guide_legend(override.aes = list(size = 3)))+
  scale_colour_manual(values = MyPalette)+
  labs(colour = "Cell cycle")
```

## Clonotype 2

```{r ,fig.width=10, fig.height=8}
tmp <- subset(SeuratObj_filt, subset = Clonotype == "cl2")


tmp@meta.data %>% 
  ggplot(aes(x= umap_1,
             y= umap_2))+
  My_umap_theme()+
  geom_point(aes(colour= Phase),
             size = .7,
             alpha = .7)+
  facet_grid(TCR ~ Condition, 
             margins = T, switch = "y")+
  theme(plot.margin = margin(t=0.05,b=0.05,l=0.05,r=0.05, unit = "in"),
        panel.background = element_rect(colour = "#555"),
        legend.key = element_blank())+
  guides(colour = guide_legend(override.aes = list(size = 3)))+
  scale_colour_manual(values = MyPalette)+
  labs(colour = "Cell cycle")
```

## Clonotype 3

```{r ,fig.width=10, fig.height=10}
tmp <- subset(SeuratObj_filt, subset = Clonotype == "cl3")


tmp@meta.data %>% 
  ggplot(aes(x= umap_1,
             y= umap_2))+
  My_umap_theme()+
  geom_point(aes(colour= Phase),
             size = .8,
             alpha = .7)+
  facet_grid(TCR ~ Condition, 
             margins = T, switch = "y")+
  theme(plot.margin = margin(t=0.05,b=0.05,l=0.05,r=0.05, unit = "in"),
        panel.background = element_rect(colour = "#555"),
        legend.key = element_blank())+
  guides(colour = guide_legend(override.aes = list(size = 3)))+
  scale_colour_manual(values = MyPalette)+
  labs(colour = "Cell cycle")
```




<br></br><br></br><br></br><br></br>

```{r}
format_duration <- function(duration) {
  total_seconds <- as.numeric(duration, units = "secs")
  
  # Calculer heures, minutes et secondes
  hours <- floor(total_seconds / 3600)
  minutes <- floor((total_seconds %% 3600) / 60)
  seconds <- round(total_seconds %% 60)
  
  # Formater l'affichage en fonction de la durée
  if (hours > 0) {
    return(sprintf("%02dh:%02dm:%02ds", hours, minutes, seconds))
  } else if (minutes > 0) {
    return(sprintf("%02dm:%02ds", minutes, seconds))
  } else {
    return(sprintf("%02ds", seconds))
  }
}

time <- Sys.time()-starting_time
time <- format_duration(time)
```

<div class='foot'> 
<p>Analysis duration :  <span style='color:darkred'>  `r time` </span></p>
<p>Time :  <span style='color:darkred'>  `r format(Sys.time(), "%H:%M:%S")` </span></p>
</div>

<p style='margin-bottom:20px'> </p>

# Session info

```{r ,include=FALSE}
saveRDS(SeuratObj_filt, file = paste0(seu_dir,"Seurat2.rds"))

if(isFALSE("Seurat2.rds" %in% readLines(paste0(seu_dir,"SeuratObjects_info")))){
  capture.output(
    cat("\n\n\n"),
    cat(c("===========", "Seurat2.rds", "==========="), sep = "\n"),
    print(SeuratObj_filt),
    cat("=======================================================", sep = "\n"),
    cat(c("Overview of the metadata :", "=========================="), sep = "\n"),
    str(SeuratObj_filt@meta.data),
  
    file = paste0(seu_dir, "SeuratObjects_info"),
    append = T
  )
}

```

```{r}
devtools::session_info()
```












